import{j as e,G as B,n as O,u as H,t as a,H as q,I as G,J as E,L as D,M as J,N as W,P as Q,q as X}from"./index-BbTZgOPh.js";import{C as U,b as F,c as p,d as x,a as h}from"./card-BIydPbpJ.js";import{t as y,B as g}from"./button-BHCxSF1w.js";import{B as Z,C as L}from"./badge-BUV8wAal.js";import{c as b}from"./createLucideIcon-D0MALnN9.js";/**
 * @license lucide-react v0.482.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const I=[["circle",{cx:"12",cy:"12",r:"10",key:"1mglay"}],["path",{d:"m9 12 2 2 4-4",key:"dzmm74"}]],Y=b("CircleCheck",I);/**
 * @license lucide-react v0.482.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const ee=[["circle",{cx:"12",cy:"12",r:"10",key:"1mglay"}]],T=b("Circle",ee);/**
 * @license lucide-react v0.482.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const se=[["circle",{cx:"12",cy:"12",r:"10",key:"1mglay"}],["polyline",{points:"12 6 12 12 16 14",key:"68esgv"}]],V=b("Clock",se);/**
 * @license lucide-react v0.482.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const ie=[["rect",{width:"14",height:"14",x:"8",y:"8",rx:"2",ry:"2",key:"17jyea"}],["path",{d:"M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2",key:"zix9uf"}]],A=b("Copy",ie);/**
 * @license lucide-react v0.482.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const ne=[["path",{d:"M2.586 17.414A2 2 0 0 0 2 18.828V21a1 1 0 0 0 1 1h3a1 1 0 0 0 1-1v-1a1 1 0 0 1 1-1h1a1 1 0 0 0 1-1v-1a1 1 0 0 1 1-1h.172a2 2 0 0 0 1.414-.586l.814-.814a6.5 6.5 0 1 0-4-4z",key:"1s6t7t"}],["circle",{cx:"16.5",cy:"7.5",r:".5",fill:"currentColor",key:"w0ekpg"}]],te=b("KeyRound",ne);/**
 * @license lucide-react v0.482.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const ae=[["path",{d:"M21.174 6.812a1 1 0 0 0-3.986-3.987L3.842 16.174a2 2 0 0 0-.5.83l-1.321 4.352a.5.5 0 0 0 .623.622l4.353-1.32a2 2 0 0 0 .83-.497z",key:"1a8usu"}],["path",{d:"m15 5 4 4",key:"1mk7zo"}]],re=b("Pencil",ae);/**
 * @license lucide-react v0.482.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const ce=[["path",{d:"M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2",key:"975kel"}],["circle",{cx:"12",cy:"7",r:"4",key:"17ys0d"}]],oe=b("User",ce);function le({session:c,aggSession:r,currentUserId:s,onAddPublicKey:d,onCreateAggSession:k,onComputeNonce:_,onCreatePartialSignature:j}){var P;const m=!!c.musig_aggregation_session,M=c.users_id.every(i=>{var t;return!!((t=c.public_keys)!=null&&t[i])}),N=(r==null?void 0:r.step)??-1,K=m&&N>=1,n=m&&N>=2,u=!!(r!=null&&r.final_signature),l=i=>{if(!r||!c.public_keys)return;const t=c.public_keys[i];if(t)return r.public_keys.includes(t)?t:void 0},S=i=>{if(!r||!r.pub_nonces)return!1;const t=l(i);return t?!!r.pub_nonces[t]:!1},v=i=>{if(!r||!r.partial_signatures)return!1;const t=l(i);return t?!!r.partial_signatures[t]:!1},z=!!((P=c.public_keys)!=null&&P[s]),f=l(s),$=S(s),R=v(s);return e.jsxs("div",{className:"space-y-6",children:[e.jsx(C,{title:"Session Creation",description:`Session created by ${c.owner_id===s?"you":y(c.owner_id)}`,status:"complete",icon:e.jsx(oe,{className:"h-5 w-5"})}),c.users_id.map(i=>{var t,o;return e.jsx(C,{title:"Public Key Addition",description:`${i===s?"You":y(i)} ${(t=c.public_keys)!=null&&t[i]?"added":"need to add"} public key`,status:(o=c.public_keys)!=null&&o[i]?"complete":"pending",icon:e.jsx(te,{className:"h-5 w-5"}),action:i===s&&!z?e.jsx(g,{size:"sm",onClick:d,children:"Add Public Key"}):null},`pubkey-${i}`)}),M&&e.jsx(C,{title:"Aggregation Session Creation",description:m?"MuSig aggregation session created":"Waiting for aggregation session creation",status:m?"complete":"pending",icon:e.jsx(V,{className:"h-5 w-5"}),action:!m&&c.owner_id===s?e.jsx(g,{size:"sm",onClick:k,children:"Create Aggregation Session"}):null}),m&&c.users_id.map(i=>{const t=l(i),o=S(i);return e.jsx(C,{title:"Nonce Computation",description:`${i===s?"You":y(i)} ${o?"submitted":"need to submit"} nonce`,status:o?"complete":t?"pending":"error",icon:e.jsx(V,{className:"h-5 w-5"}),action:i===s&&!$&&f&&N===0?e.jsx(g,{size:"sm",onClick:_,children:"Compute Nonce"}):null},`nonce-${i}`)}),K&&c.users_id.map(i=>{const t=l(i),o=v(i);return e.jsx(C,{title:"Partial Signature",description:`${i===s?"You":y(i)} ${o?"submitted":"need to submit"} partial signature`,status:o?"complete":t?"pending":"error",icon:e.jsx(re,{className:"h-5 w-5"}),action:i===s&&!R&&f&&N===1?e.jsx(g,{size:"sm",onClick:j,children:"Create Partial Signature"}):null},`partsig-${i}`)}),n&&e.jsx(C,{title:"Signature Verification",description:u?"Final signature verified successfully":"Awaiting final signature verification",status:u?"complete":"pending",icon:e.jsx(Y,{className:"h-5 w-5"}),action:!u&&c.owner_id===s?e.jsx(g,{size:"sm",children:"Verify Signature"}):null})]})}function C({title:c,description:r,status:s,icon:d,action:k}){return e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:`rounded-full p-2 ${s==="complete"?"bg-green-100 text-green-700":s==="pending"?"bg-gray-100 text-gray-500":"bg-red-100 text-red-700"}`,children:d}),e.jsxs("div",{children:[e.jsx("p",{className:"font-medium",children:c}),e.jsx("p",{className:"text-sm text-gray-500",children:r})]})]}),e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsx(Z,{className:`${s==="complete"?"bg-green-100 text-green-700 hover:bg-green-100":s==="pending"?"bg-gray-100 text-gray-500 hover:bg-gray-100":"bg-red-100 text-red-700 hover:bg-red-100"}`,children:s==="complete"?e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx(Y,{className:"h-3.5 w-3.5 mr-1"}),"Complete"]}):s==="pending"?e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx(T,{className:"h-3.5 w-3.5 mr-1"}),"Pending"]}):e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx(T,{className:"h-3.5 w-3.5 mr-1"}),"Error"]})}),k]})]})}const xe=function(){const{currentUserId:r,session:s,aggSession:d}=B.useLoaderData(),k=O(),_=H(),j=(n,u)=>{navigator.clipboard.writeText(n).then(()=>{a("Copied to clipboard",{description:`${u} has been copied to your clipboard.`})})};if(!s)return e.jsx("div",{children:"Loading..."});const m=async()=>{try{const n={musig_session_id:s.session_id,key_name:`${k}_key1`},u=X(n);a.promise(u,{loading:"Updating public key...",success:"Public key updated successfully",error:"Failed to update public key"}),await u,_.invalidate()}catch(n){console.error("Error in MuSig session creation:",n),a.error("An error occurred during the process")}},M=async()=>{try{if(!s.users_id.every(o=>{var w;return!!((w=s.public_keys)!=null&&w[o])})){a.error("Cannot create aggregation session until all participants have added their public keys");return}a.loading("Creating aggregation session...");const u=new Map(Object.entries(s.public_keys)),l=new Map(Object.entries(s.signer_indexes));let S=Array(s.users_id.length).fill("");const v=Array.from(l.keys());for(const o of v){const w=l.get(o);S[w]=u.get(o)}const z={public_keys:S,initiating_key:s.owner_id,message:s.msg},f=await J(z),$={musig_session_id:s.session_id,musig_aggregation_id:f};await W($);const R=await Q(f),P={musig_session_id:s.session_id,key_agg_context:R.key_agg_context},t=await E(P);t.musig_session_id=f,await D(t),a.dismiss(),a.success("Aggregation session created and nonce submitted successfully"),_.invalidate()}catch(n){a.dismiss(),console.error("Error creating aggregation session:",n),a.error("Failed to create aggregation session",{description:n instanceof Error?n.message:"Unknown error"})}},N=async()=>{if(!d){a.error("Aggregation session not found");return}try{a.loading("Computing public nonce...");const n={musig_session_id:s.session_id,key_agg_context:d.key_agg_context},l=await E(n);l.musig_session_id=d.id,await D(l),a.dismiss(),a.success("Nonce submitted successfully"),_.invalidate()}catch(n){a.dismiss(),console.error("Error submitting nonce:",n),a.error("Failed to submit nonce",{description:n instanceof Error?n.message:"Unknown error"})}},K=async()=>{if(!d){a.error("Aggregation session not found");return}try{a.loading("Computing partial signature...");const n={musig_session_id:s.session_id,key_agg_context:d.key_agg_context,agg_nonce:d.agg_nonce},l=await q(n);l.musig_session_id=d.id,await G(l),a.dismiss(),a.success("Partial signature submitted successfully"),_.invalidate()}catch(n){a.dismiss(),console.error("Error submitting partial signature:",n),a.error("Failed to submit partial signature",{description:n instanceof Error?n.message:"Unknown error"})}};return e.jsxs("div",{className:"flex flex-col gap-4",children:[e.jsxs(U,{children:[e.jsxs(F,{children:[e.jsx(p,{children:"MuSig Session Information"}),e.jsx(x,{children:"Information about the current MuSig session"})]}),e.jsxs(h,{className:"pb-2",children:[e.jsx(x,{children:"Session Name"}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(p,{className:"text-sm font-medium",children:s.session_name}),e.jsxs(g,{variant:"ghost",size:"icon",className:"size-6 hover:cursor-pointer",onClick:()=>j(s.session_name,"Session Name"),children:[e.jsx(A,{className:"h-3.5 w-3.5"}),e.jsx("span",{className:"sr-only",children:"Copy session name"})]})]})]}),e.jsxs(h,{className:"pb-2",children:[e.jsx(x,{children:"Session ID"}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(p,{className:"text-sm font-medium",children:y(s.session_id)}),e.jsxs(g,{variant:"ghost",size:"icon",className:"size-6 hover:cursor-pointer",onClick:()=>j(s.session_id,"Session ID"),children:[e.jsx(A,{className:"h-3.5 w-3.5"}),e.jsx("span",{className:"sr-only",children:"Copy session ID"})]})]})]}),e.jsxs(h,{className:"pb-2",children:[e.jsx(x,{children:"Participants"}),e.jsx("div",{className:"flex flex-col gap-2",children:s.users_id.map(n=>e.jsxs(p,{className:"text-sm font-medium flex items-center gap-1",children:[e.jsx(L,{className:"size-4"}),y(n)," ",n===r&&"(You)"]},n))})]}),e.jsxs(h,{className:"pb-2",children:[e.jsx(x,{children:"Owner ID"}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs(p,{className:"text-sm font-medium flex items-center gap-1",children:[e.jsx(L,{className:"size-4"}),y(s.owner_id)," ",s.owner_id===r&&"(You)"]}),e.jsxs(g,{variant:"ghost",size:"icon",className:"size-6 hover:cursor-pointer",onClick:()=>j(s.owner_id,"Owner ID"),children:[e.jsx(A,{className:"h-3.5 w-3.5"}),e.jsx("span",{className:"sr-only",children:"Copy owner ID"})]})]})]}),e.jsxs(h,{className:"pb-2",children:[e.jsx(x,{children:"Message"}),e.jsx("div",{className:"flex items-center gap-2",children:e.jsx(p,{className:"text-sm font-medium",children:s.msg})})]}),e.jsxs(h,{className:"pb-2",children:[e.jsx(x,{children:"MuSig Aggregation Session"}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(p,{className:"text-sm font-medium",children:s.musig_aggregation_session??e.jsx("i",{children:"No info"})}),e.jsxs(g,{variant:"ghost",size:"icon",className:"size-6 hover:cursor-pointer",onClick:()=>j(s.musig_aggregation_session,"MuSig Aggregation Session"),children:[e.jsx(A,{className:"h-3.5 w-3.5"}),e.jsx("span",{className:"sr-only",children:"Copy MuSig Aggregation Session"})]})]})]})]}),e.jsxs(U,{children:[e.jsxs(F,{children:[e.jsx(p,{children:"Activity"}),e.jsx(x,{children:"Information about the current MuSig session"})]}),e.jsx(h,{children:e.jsx(le,{session:s,aggSession:d,currentUserId:r,onAddPublicKey:m,onCreateAggSession:M,onComputeNonce:N,onCreatePartialSignature:K})})]})]})};export{xe as component};
